<!DOCTYPE html>
<html>
<head>
    <title>Switch Config Tool</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

    <!-- Header section -->
    <header style="display: flex; align-items: center; justify-content: space-between;">
        <div>
            <img src="{{ url_for('static', filename='Com1-Oranje.png') }}" alt="Logo">
        </div>
        <h1>Push Config to Switch</h1>
        <a href="{{ url_for('show_logs') }}" class="btn view-logs-btn">ðŸ“„ View Logs</a>
    </header>

    <!-- Main Form for sending config -->
    <form method="POST">
        <h4>Select Devices:</h4>

        <!-- Device filtering options -->
        <input type="text" id="device-search" placeholder="Search by IP..." style="width: 250px;">
        <label><input type="checkbox" id="filter-password"> Show only devices with password</label>
        <label><input type="checkbox" id="filter-no-password"> Show only devices without password</label>
        <button type="button" id="select-visible">Select All Visible</button>
        <button type="button" id="deselect-all">Deselect All Devices</button>
        <button type="button" id="select-all">Select All Devices</button>

        <!-- Device list with dynamic variable entry per device -->
        <div id="device-list">
            {% for device in devices %}
            <div class="device-entry" data-ip="{{ device.ip }}" data-password="{{ 'yes' if device.has_password else 'no' }}">
                <div class="device-row">
                    <label>
                        <input type="checkbox" class="device-checkbox" name="devices" value="{{ device.id }}" data-form="{{ device.form_id }}">
                        {{ device.label }}
                    </label>

                    <div class="variable-fields" style="display: none;">
                        <div class="var-pairs">
                            <input type="text" name="var_{{ device.form_id }}_0_key" placeholder="Variable name">
                            <input type="text" name="var_{{ device.form_id }}_0_value" placeholder="Value">
                        </div>
                        <button type="button" class="add-var-btn" data-device="{{ device.form_id }}">+ Add Variable</button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>


        <!-- Configuration file and protocol selection -->
        <label>Select Config File:</label>
        <select name="config">
            {% for config in configs %}
                <option value="{{ config }}">{{ config }}</option>
            {% endfor %}
        </select><br>

        <label>Protocol:</label>
        <select name="protocol">
            <option value="ssh">SSH</option>
            <option value="telnet">Telnet</option>
        </select><br>

        <label>Cooldown (ms):</label>
        <input type="number" name="cooldown" value="1000"><br>

        <button name="send_config" type="submit">Send Config</button>
    </form>

    <!-- Result output -->
    {% if result %}
        <h2>Result:</h2>
        <pre>{{ result }}</pre>
    {% endif %}

    <!-- Quick test mode button -->
    <form method="POST" action="/test-send" style="margin-top: 15px;">
        <button type="submit" class="btn" style="background-color: orange;">Test Send Config</button>
    </form>

    <!-- File upload form -->
    <form method="POST" action="/upload" enctype="multipart/form-data">
        <h2>Upload Device or Config File</h2>
        <input type="file" name="file" required>
        <select name="filetype">
            <option value="devices">Device</option>
            <option value="configs">Config</option>
        </select>
        <button type="submit">Upload</button>
    </form>

    <!-- File deletion form -->
    <form method="POST" action="/delete">
        <h2>Delete Files</h2>
        <select name="filetype">
            <option value="devices">Device</option>
            <option value="configs">Config</option>
        </select>
    <!-- Dropdowns appear based on selected type -->
        <div id="delete-file-selects">
            <select id="delete-device-select" name="filename" style="display:none;">
                {% for f in device_files %}
                    <option value="{{ f }}">{{ f }}</option>
                {% endfor %}
            </select>

            <select id="delete-config-select" name="filename" style="display:none;">
                {% for f in config_files %}
                    <option value="{{ f }}">{{ f }}</option>
                {% endfor %}
            </select>
        </div>        
        <button type="submit">Delete</button>
    </form>

    <!-- Device file format hints -->
    <form>
        <h2>Device File Format</h2>
        <label>With password:</label>
        <pre>
            192.168.1.1
            username:admin
            password:secret
        </pre>
        <label>Without password:</label>
        <pre>
            192.168.1.1
        </pre>
    </form>

    <footer>
        Made by Ahmad Mahouk
    </footer>

    <!-- JavaScript behavior for filtering, variable entry, and toggling -->
    <script>
    $(document).ready(function () {
        function filterDevices() {
            const search = $("#device-search").val().toLowerCase();
            const filterPwd = $("#filter-password").is(":checked");
            const filterNoPwd = $("#filter-no-password").is(":checked");

            $(".device-entry").each(function () {
                const ip = $(this).data("ip").toLowerCase();
                const hasPwd = $(this).data("password") === "yes";
                const matchesSearch = ip.includes(search);
                const matchesWithPwd = !filterPwd || hasPwd;
                const matchesNoPwd = !filterNoPwd || !hasPwd;

                if (matchesSearch && matchesWithPwd && matchesNoPwd) {
                    $(this).show();
                } else {
                    $(this).hide();
                    $(this).find("input[type=checkbox]").prop("checked", false);
                    $(this).find(".variable-fields").hide();
                }
            });
        }

        // File deletion based on selected type
        const filetypeSelect = document.querySelector("select[name='filetype']");
        const deviceSelect = document.getElementById("delete-device-select");
        const configSelect = document.getElementById("delete-config-select");

        function updateVisibleSelect() {
            const type = filetypeSelect.value;
            deviceSelect.style.display = (type === "devices") ? "inline-block" : "none";
            configSelect.style.display = (type === "configs") ? "inline-block" : "none";
        }

        filetypeSelect.addEventListener("change", updateVisibleSelect);
        updateVisibleSelect();


        // Filtering events
        $("#device-search").on("input", filterDevices);
        $("#filter-password").on("change", filterDevices);
        $("#filter-no-password").on("change", filterDevices);

        // Selection helpers
        $("#select-visible").on("click", function () {
            $(".device-entry:visible input[type=checkbox]").prop("checked", true).trigger("change");
        });
        $("#select-all").on("click", function () {
            $(".device-entry input[type=checkbox]").prop("checked", true).trigger("change");
        });
        $("#deselect-all").on("click", function () {
            $(".device-entry input[type=checkbox]").prop("checked", false).trigger("change");
        });

        // Toggle variable section visibility per device
        $(document).on("change", ".device-checkbox", function () {
            const entry = $(this).closest(".device-entry");
            const variableFields = entry.find(".variable-fields");
            this.checked ? variableFields.show() : variableFields.hide().find("input[type='text']").val("");
        });

        // Add more variable fields per device
        $(document).on("click", ".add-var-btn", function () {
            const deviceId = $(this).data("device");
            const container = $(this).siblings(".var-pairs").last().parent();
            const index = container.find(".var-pairs").length;
            const newRow = `
                <div class="var-pairs">
                    <input type="text" name="var_${deviceId}_${index}_key" placeholder="Variable name" style="width: 150px;">
                    <input type="text" name="var_${deviceId}_${index}_value" placeholder="Value" style="width: 150px;">
                </div>`;
            $(this).before(newRow);
        });


    });
    </script>
</body>
</html>
